---
title: "Survey Batch Statistics"
author: 'KLPS COVID-19 Sample'
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    fig_width: 7
    fig_height: 5.5
    theme: paper
    toc: FALSE
#    includes: 
#      before_body: header.html
#runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(haven)
library(tidyverse)
library(dygraphs)
library(xts)
# library(shiny)
# library(plotly)
# library(htmltools)

endweek = 20
endweektext = "August 21"


require(haven)
covid_batch <- read_dta("/Users/zhang/Documents/GitHub/covid/data/outcomes_R_fullsample_batch.dta")
covid_batch_mf <- read_dta("/Users/zhang/Documents/GitHub/covid/data/outcomes_R_malefemale_batch.dta")
covid_batch_ur <- read_dta("/Users/zhang/Documents/GitHub/covid/data/outcomes_R_urbanrural_batch.dta")
covid_batch_tc <- read_dta("/Users/zhang/Documents/GitHub/covid/data/outcomes_R_treatcontrol_batch.dta")
covid_batch_oy <- read_dta("/Users/zhang/Documents/GitHub/covid/data/outcomes_R_oldyoung_batch.dta")

## Add batch median date 
## NA rows for week 2 and endweek (annotation)
batch_index <- data.frame(batch = c(NA,1:5, NA), twoweeks = c(2, 3.429, 6.571, 9.571, 13.143, 16.714, endweek))
covid_batch <- rbind(rep(NA,69),covid_batch)
covid_batch <- merge(covid_batch, batch_index, by = "batch")
covid_batch <-covid_batch[order(covid_batch$twoweeks),]

covid_batch_mf <- rbind(rep(NA,70),rep(NA,70),covid_batch_mf)
covid_batch_mf <- merge(covid_batch_mf, batch_index, by = "batch")
covid_batch_mf[covid_batch_mf$twoweeks==2,"female"] <- c(1,0)
covid_batch_mf[covid_batch_mf$twoweeks==endweek,"female"] <- c(1,0)

covid_batch_ur <- rbind(rep(NA,70),covid_batch_ur)
covid_batch_ur <- merge(covid_batch_ur, batch_index, by = "batch")
covid_batch_ur[covid_batch_ur$twoweeks==2,"urban"] <- c(1,0)
covid_batch_ur[covid_batch_ur$twoweeks==endweek,"urban"] <- c(1,0)


covid_batch_tc <- rbind(rep(NA,70),rep(NA,70),covid_batch_tc)
covid_batch_tc <- merge(covid_batch_tc, batch_index, by = "batch")
covid_batch_tc[covid_batch_tc$twoweeks==2,"psdp_treat"] <- c(1,0)
covid_batch_tc[covid_batch_tc$twoweeks==endweek,"psdp_treat"] <- c(1,0)


covid_batch_oy <- rbind(rep(NA,70),covid_batch_oy)
#covid_batch_oy <- rbind(rep(NA,70),rep(NA,70),covid_batch_oy)
covid_batch_oy <- merge(covid_batch_oy, batch_index, by = "batch")
covid_batch_oy[covid_batch_oy$twoweeks==2,"older"] <- c(1,0)
covid_batch_oy[covid_batch_oy$twoweeks==endweek,"older"] <- c(1,0)


#grouping consumption vars 
c <- c("twoweeks", "c2_wins", "c3_wins","c4_wins") 
c <- covid_batch[c]

#grouping earnings (income) vars 
i <- c("twoweeks", "i4_wins", "i3_wins", "i2_wins" , "i1_wins")
i <- covid_batch[i]
i <- i[order(i$twoweeks),]
i <- rbind(c(-1,covid_batch$i4_feb2020_wins[3],covid_batch$i3_feb2020_wins[3],covid_batch$i2_feb2020_wins[3],covid_batch$i1_feb2020_wins[3]),i)

i_self <- c("twoweeks", "i4_self_wins", "i3_self_wins", "i2_self_wins")#, "i1_self_wins")
i_self <- covid_batch[i_self]

##transfers 
tf <- c("twoweeks", "i5_wins", "i6")
tf <- covid_batch[tf]
#tf <- tf[order(tf$twoweeks),]

#grouping labor vars 
l <- c("twoweeks", "l1_tc", "l2_tc", "l3_tc", "l4_tc")
l <- covid_batch[l]
#l<- l[order(l$twoweeks),]

cc <- c("twoweeks", "l5_tc")
cc <- covid_batch[cc]

ue <- c("twoweeks", "l6", "l7")
ue <- covid_batch[ue]

#food security vars
f1_d <- c("twoweeks","f1_d_skippedadult", "f1_d_skippedchild", "f1_d_hungryadult", "f1_d_hungrychild", "f1_d_nofoodadult", "f1_d_nofoodchild")
f1_d <- covid_batch[f1_d]

f1_idx <- c("twoweeks", "f1", "f3", "f4")
f1_idx <- covid_batch[f1_idx]

f1_meals <- c("twoweeks", "f1_meat", "f1_eggs")
f1_meals <- covid_batch[f1_meals]

#covid vars 
ckn <- c("twoweeks", "ckn1", "ckn2", "ckn3", "ckn4")
ckn <- covid_batch[ckn]

cbc <- c("twoweeks", "cbc1", "cbc2", "cbc3")
cbc <- covid_batch[cbc]

cov1 <- c("twoweeks", "cov1_fever", "cov1_tired", "cov1_cough", "cov1_dbreath")
cov1 <- covid_batch[cov1]

s3 <-  covid_batch[c("twoweeks", "s3_4travel")]
#In the past 14 days, did  you travel to (and returned from) another town or city

# mental health vars
mh <- c("twoweeks", 'nervous' ,'lonely', 'hopeful', 'phyreaction','depressed')
mh <- covid_batch[mh]

# valueformatter for x axis
getMedianDate <- "function(d) {
                var dateNames = ['Feb','0', '1', '2', 'April 27 (Batch 1)',
                  '4', '5','6', 'May 19 (Batch 2)',
                     '8', '9', 'June 09 (Batch 3)',
                     '11','12','July 04 (Batch 4)',
                '14','15','16','July 29 (Batch 5)',
                '18','19','20'];
                var index = Math.round(d)+1;
                return dateNames[index]+'  '; }" #(median date)

getMedianDateNote <- "function(d) {
                var dateNames = ['Feb','0', '1', '2', 'April 27 (Batch 1 median date)',
                  '4', '5','6', 'May 19 -(Batch 2 median date)',
                     '8', '9', 'June 09 -(Batch 3 median date)',
                     '11','12','July 04 -(Batch 4 median date)',
                '14','15','16','July 29 -(Batch 5 median date)',
                '18','19','20'];
                var index = Math.round(d)+1;
                return dateNames[index]+'  '; }" #(median date)

getMedianDateOnly <- "function(d) {
                var dateNames = ['Feb','0', '1', '2', 'April 27 ',
                  '4', '5','6', 'May 19 ',
                     '8', '9', 'June 09 ',
                     '11','12','July 04 ',
                '14','15','16','July 29 ',
                '18','19','20'];
                var index = Math.round(d)+1;
                return dateNames[index]+'  '; }" #(median date)


# Batch median date annotation
 median_w <-c(3.429, 6.571, 9.571, 13.143, 16.714)
 median_d <-c("April 27","May 19","June 09","July 04","July 29")


presAnnotation <- function(dygraph, below = FALSE, height = 5) {
  h <- height
  if (below == TRUE) {h <- -35}
  dygraph %>%
      dyAnnotation("2", text = "April 17", attachAtBottom = TRUE, width = 55, height = 25) %>%
    dyAnnotation(median_w[1],  text = median_d[1], attachAtBottom = TRUE, width = 40, height = 20,tooltip = "Batch 1", tickHeight = h,cssClass = 'batch-annotation') %>% 
    dyAnnotation(median_w[2],  text = median_d[2], attachAtBottom = TRUE, width = 40, height = 20, tooltip = "Batch 2", tickHeight = h,cssClass = 'batch-annotation') %>%
    dyAnnotation(median_w[3],  text = median_d[3], attachAtBottom = TRUE, width = 40, height = 20,tooltip = "Batch 3", tickHeight = h,cssClass = 'batch-annotation') %>% 
    dyAnnotation(median_w[4],  text = median_d[4], attachAtBottom = TRUE, width = 40, height = 20,tooltip = "Batch 4", tickHeight = h,cssClass = 'batch-annotation') %>% 
    dyAnnotation(median_w[5],  text = median_d[5], attachAtBottom = TRUE, width = 40, height = 20,tooltip = "Batch 5", tickHeight = h,cssClass = 'batch-annotation') %>% 
      dyAnnotation(endweek,  text = endweektext, attachAtBottom = TRUE, width = 70, height = 25)
}



# Data prep in groups global func
data_group <- function(dataset, varlist, factor){
     df_a <- subset(dataset,factor == 1,varlist)
   df_b <- subset(dataset,factor == 0,varlist)
   df_ab<- merge(df_a, df_b, by = "twoweeks", suffixes = c(".1",".0"))
}
```


  
```{css echo=FALSE}
.sideby {
 # display: inline-block;
 # position: relative;
	float: left;
	width: 50%;
	padding: 10px;
	box-sizing: border-box;
}


.dygraph-legend {
  #left: 70px !important;
  background-color: transparent !important;
}

.dygraph-legend_left {
  left: 70px !important;
  background-color: transparent !important;
}

.few .dygraph-legend > span.highlight { border: 1px solid grey; font-weight: boldest; }


.dygraph-default-annotation {
    border: 1px solid green;
    background-color: white;
    text-align: center;
}

.batch-annotation{
    border: 1px solid rgb(208,208,208) !important;
    font-size: 0.8em !important;
    color: gray !important;
    background-color: transparent !important;
    text-align: center;
}
```

Use batch averages and median dates.

## {.tabset}

### Income
<font size="5">**Household Earnings per capita (USD, PPP) - past 14 days**</font>


####  {.tabset .tabset-pills}

##### Full sample 
```{r income}
presOptions_income <- function(dygraph) {
  dygraph %>%
    dyAxis("x", pixelsPerLabel = 40 , drawGrid = FALSE, label = "Weeks", rangePad = 20, valueFormatter = htmlwidgets::JS(getMedianDate)) %>% 
  dyAxis("y", label = "USD, PPP (2018) ", drawGrid = FALSE, valueRange = c(0,85)) %>% 
  dyLegend(width = 300, labelsSeparateLines = TRUE) %>%
    dyCrosshair(direction = "vertical") %>%
    presAnnotation(below = TRUE) %>% 
  dyEvent(0 , "Lockdown begins March 15", labelLoc = "top") %>%
  dyEvent(-1 , "February", labelLoc = "bottom", strokePattern = "solid", color = "gray") %>%
  dyHighlight(highlightSeriesOpts = list(strokeWidth = 3))
}

i_g <- dygraph(i, main = "") %>%
  dySeries("i4_wins", strokeWidth = 5, label = "Total earnings") %>%
  dySeries("i3_wins", strokeWidth = 4, label = "Wage earnings") %>%
  dySeries("i2_wins", strokeWidth = 4, label = "Self-employment earnings") %>%
  dySeries("i1_wins", strokeWidth = 4, label = "Agricultural earnings") %>%
presOptions_income() %>% 
  dyOptions(stackedGraph = FALSE, includeZero = TRUE, axisLineWidth = 4, drawPoints = TRUE, pointSize = 4, colors = RColorBrewer::brewer.pal(5, "Set2"), connectSeparatedPoints = FALSE, rightGap = 20) %>%
  dyHighlight(highlightSeriesOpts = list(strokeWidth = 3))%>% 
  dyLimit(limit = covid_batch$i4_precovid[3], "                 Pre-COVID average, Total earnings pc", strokePattern = "dotted", color = "green")  
 # dyEvent(median_w[1], paste0("Batch 1", median_d[1]), labelLoc = "top" ,color = "red") 
i_g
```



##### Female/Male
```{r income_fm}
color_income <- c("#FC8D62", "#8DA0CB", "#E78AC3")
#income graphs group func
i_g_group <- function(dataset,factor, group_label, title_text){
  # Variable prep, careful with the order and v_ab[col]
  income_var <- colnames(i)
  v_ab <- data_group(dataset, income_var, factor)
  i_feb2020.1 <- c(dataset[factor==1,]$i4_feb2020_wins[1], dataset[factor==1,]$i3_feb2020_wins[1],NA, NA) # Add feb (only i4,i3)
  i_feb2020.0 <- c(dataset[factor==0,]$i4_feb2020_wins[1], dataset[factor==0,]$i3_feb2020_wins[1],NA, NA)
  v_ab <- rbind(c(-2,NA,NA,NA,NA,NA,NA,NA,NA),v_ab)
  v_ab <- rbind(c(-1,i_feb2020.1[1],i_feb2020.1[2],i_feb2020.1[3],i_feb2020.1[4],
                     i_feb2020.0[1],i_feb2020.0[2],i_feb2020.0[3],i_feb2020.0[4]),v_ab) 
     v_ab.col <- colnames(v_ab)
  # graghing 
  v_g_ab <- dygraph(v_ab[c(1,2,6)],main = "")%>% 
    dySeries(v_ab.col[2], strokeWidth = 5, label = group_label[7], strokePattern = "dashed", strokeBorderWidth = 1) %>%
    dySeries(v_ab.col[6], strokeWidth = 5, label = group_label[8], strokeBorderWidth = 1) %>%
    presOptions_income() %>%
    dyOptions(stackedGraph = FALSE, colors = c("#005a32","#41ab5d"), fillGraph = FALSE, includeZero = TRUE, axisLineWidth = 4, drawPoints = TRUE, pointSize = 4, connectSeparatedPoints = FALSE, rightGap = 20) %>% 
      dyLimit(limit = covid_batch$i4_precovid[3], "                 Pre-COVID average, Total earnings pc", strokePattern = "dotted", color = "green")
    
  v_g_a <- dygraph(v_ab[c(1,3:5)], main = title_text[2]) %>% # grouping
    dySeries(v_ab.col[3], strokeWidth = 4, label = group_label[1], strokePattern = "dashed") %>%
    dySeries(v_ab.col[4], strokeWidth = 4, label = group_label[2], strokePattern = "dashed") %>%
    dySeries(v_ab.col[5], strokeWidth = 4, label = group_label[3], strokePattern = "dashed") %>%
    presOptions_income() %>%
    dyOptions(stackedGraph = FALSE, colors = color_income, includeZero = TRUE, axisLineWidth = 4, drawPoints = TRUE, pointSize = 4, connectSeparatedPoints = FALSE, rightGap = 20)

  i_g_b <- dygraph(v_ab[c(1,7:9)], main = title_text[3])  %>%
    dySeries(v_ab.col[7], strokeWidth = 4, label = group_label[4]) %>%
    dySeries(v_ab.col[8], strokeWidth = 4, label = group_label[5]) %>%
    dySeries(v_ab.col[9], strokeWidth = 4, label = group_label[6]) %>%
    presOptions_income() %>%
    dyOptions(stackedGraph = FALSE, colors = color_income, includeZero = TRUE, axisLineWidth = 4, drawPoints = TRUE, pointSize = 4, connectSeparatedPoints = FALSE, rightGap = 20) %>% 
  dyAxis("y", label = "", drawGrid = FALSE, valueRange = c(0,85)) 
  
  g <- list(v_g_ab, v_g_a, i_g_b)
}

# Labels prep
i_glab_fm<- c("Female: Wage earnings", "Female: Self-employment earnings", 
                 "Female: Agricultural earnings", 
                 "Male: Wage earnings", "Male:  Self-employment earnings", 
                 "Male: Agricultural earnings","Female: Total Earnings", "Male: Total Earnings")
i_g_groupfm <- i_g_group(covid_batch_mf, covid_batch_mf$female, i_glab_fm, title_text = c("Female/Male","Female", "Male"))
i_g_groupfm[[1]]
```

###### {.sideby}
```{r fig.width=5, fig.height=4}
i_g_groupfm[[2]]
```

###### {.sideby}

```{r fig.width=5, fig.height=4}
i_g_groupfm[[3]]
```


##### Urban/Rural
```{r income_ur}
i_glab_ur<- c("Urban: Wage earnings", "Urban: Self-employment earnings", 
                 "Urban: Agricultural earnings", 
                 "Rural: Wage earnings", "Rural:  Self-employment earnings", 
                 "Rural: Agricultural earnings", "Urban Total Earnings", "Rural Total Earnings")
i_g_groupur <-i_g_group(covid_batch_ur, i_glab_ur, factor = covid_batch_ur$urban,title_text = c("Urban/Rural", 'Urban', 'Rural'))
i_g_groupur[[1]]
```

###### {.sideby}
```{r fig.width=5, fig.height=4}
i_g_groupur[[2]]
```

###### {.sideby}
```{r fig.width=5, fig.height=4}
i_g_groupur[[3]]
```


####
 
  This plot shows the average earning per capita in the past 14 days, across all working-age household members including children. It also plots three earning sources respectively. If the household does not perceive income from one or more of the sources, those data points are assigned zeros to assure representativeness for the whole population. 
  
***  
<font size="5">**Individual Earnings (USD, PPP) - past 14 days**</font>


####  {.tabset .tabset-pills}

##### Full sample 

```{r incomeind}
## dygraph presOptions func
presOptions_incomeind <- function(dygraph) {
  dygraph %>%
    dyAxis("x", pixelsPerLabel = 40 , drawGrid = FALSE, label = "Weeks", rangePad = 20,valueFormatter = htmlwidgets::JS(getMedianDate)) %>% 
  dyAxis("y", label = "USD, PPP (2018) ", drawGrid = FALSE, valueRange = c(0,180)) %>% 
  dyLegend(width = 300, labelsSeparateLines = TRUE) %>%
    dyCrosshair(direction = "vertical") %>%
    presAnnotation() %>% 
  dyEvent(0 , "Lockdown begins March 15", labelLoc = "top") %>%
 # dyEvent(-1 , "February", labelLoc = "bottom", strokePattern = "solid", color = "gray") %>%
  dyHighlight(highlightSeriesOpts = list(strokeWidth = 3))
}

ii_g <- dygraph(i_self, main = "") %>%
  dySeries("i4_self_wins", strokeWidth = 5, label = "Total earnings") %>%
  dySeries("i3_self_wins", strokeWidth = 4, label = "Wage earnings") %>%
  dySeries("i2_self_wins", strokeWidth = 4, label = "Self-employment earnings") %>%
#  dySeries("i1_self_wins", strokeWidth = 4, label = "Agricultural earnings") %>%
presOptions_incomeind() %>% 
  dyOptions(stackedGraph = FALSE, includeZero = TRUE, axisLineWidth = 4, drawPoints = TRUE, pointSize = 4, colors = RColorBrewer::brewer.pal(5, "Set2"), connectSeparatedPoints = FALSE, rightGap = 20) %>%
  dyHighlight(highlightSeriesOpts = list(strokeWidth = 3)) %>% 
  dyLimit(limit = covid_batch$i4_self_precovid[3], "Pre-COVID average, Total earnings", strokePattern = "dotted", color = "green")
ii_g
```



##### Female/Male
```{r incomeind_fm}
color_income <- c("#FC8D62", "#8DA0CB", "#E78AC3")

ii_g_group <- function(dataset,factor, group_label, title_text){
  income_var <- colnames(i_self)# , "i1_self_wins") 1,2,6 / 1,3:5 / 1, 7:9
  v_ab <- data_group(dataset, income_var, factor)
  #Add Feb?
    v_ab.col <- colnames(v_ab)
  
  #graghing 
  v_g_ab <- dygraph(v_ab,main = "")%>% 
    dySeries(v_ab.col[2], strokeWidth = 6, pointSize = 5, label = group_label[7], strokePattern = "dashed", strokeBorderWidth = 1) %>%
    dySeries(v_ab.col[5], strokeWidth = 6, pointSize = 5, label = group_label[8], strokeBorderWidth = 1) %>%
    dySeries(v_ab.col[3], strokeWidth = 4, pointSize = 4, label = group_label[1], strokePattern = "dashed") %>%
    dySeries(v_ab.col[6], strokeWidth = 4, pointSize = 4, label = group_label[4]) %>%
    dySeries(v_ab.col[4], strokeWidth = 4, pointSize = 4, label = group_label[2], strokePattern = "dashed") %>%
    dySeries(v_ab.col[7], strokeWidth = 4, pointSize = 4, label = group_label[5]) %>%
    presOptions_incomeind() %>%
    dyOptions(stackedGraph = FALSE, colors = c("#005a32","#41ab5d", "#FC8D62", "#FC8D62", "#8DA0CB","#8DA0CB"), fillGraph = FALSE, includeZero = TRUE, axisLineWidth = 4, drawPoints = TRUE, connectSeparatedPoints = FALSE, rightGap = 20) %>%
    dyLimit(limit = covid_batch$i4_self_precovid[3], "Pre-COVID average, Total earnings", strokePattern = "dotted", color = "green")
#   v_g_ab <- dygraph(v_ab[c(1,2,5)],main = "")%>% #paste0("Earnings per capita (USD, PPP) - past 14 day,  ",title_text[1])
#     dySeries(v_ab.col[2], strokeWidth = 5, label = group_label[7], strokePattern = "dashed", strokeBorderWidth = 1) %>%
#     dySeries(v_ab.col[5], strokeWidth = 5, label = group_label[8], strokeBorderWidth = 1) %>%
#     presOptions_incomeind() %>%
#     dyOptions(stackedGraph = FALSE, colors = c("#005a32","#41ab5d"), fillGraph = FALSE, includeZero = TRUE, axisLineWidth = 4, drawPoints = TRUE, pointSize = 4, connectSeparatedPoints = FALSE, rightGap = 20) %>% 
#       dyLimit(limit = covid_batch$i4_self_precovid[3], "Pre-COVID average, Total earnings", strokePattern = "dotted", color = "green")
#     
#   v_g_a <- dygraph(v_ab[c(1,3:4)], main = title_text[2]) %>% # grouping
#     dySeries(v_ab.col[3], strokeWidth = 4, label = group_label[1], strokePattern = "dashed") %>%
#     dySeries(v_ab.col[4], strokeWidth = 4, label = group_label[2], strokePattern = "dashed") %>%
# #    dySeries(v_ab.col[5], strokeWidth = 4, label = group_label[3], strokePattern = "dashed") %>%
#     presOptions_incomeind() %>%
#     dyOptions(stackedGraph = FALSE, colors = color_income, includeZero = TRUE, axisLineWidth = 4, drawPoints = TRUE, pointSize = 4, connectSeparatedPoints = FALSE, rightGap = 20)
# 
#   i_g_b <- dygraph(v_ab[c(1,6:7)], main = title_text[3])  %>%
#     dySeries(v_ab.col[6], strokeWidth = 4, label = group_label[4]) %>%
#     dySeries(v_ab.col[7], strokeWidth = 4, label = group_label[5]) %>%
# #    dySeries(v_ab.col[9], strokeWidth = 4, label = group_label[6]) %>%
#     presOptions_incomeind() %>%
#     dyOptions(stackedGraph = FALSE, colors = color_income, includeZero = TRUE, axisLineWidth = 4, drawPoints = TRUE, pointSize = 4, connectSeparatedPoints = FALSE, rightGap = 20)
# 
#   g <- list(v_g_ab, v_g_a, i_g_b)
}

# Labels prep
i_glab_fm<- c("Female: Wage earnings", "Female: Self-employment earnings", 
                 "Female: Agricultural earnings", 
                 "Male: Wage earnings", "Male:  Self-employment earnings", 
                 "Male: Agricultural earnings","Female: Total Earnings", "Male: Total Earnings")
i_g_groupfm <- ii_g_group(covid_batch_mf, covid_batch_mf$female, i_glab_fm, title_text = c("Female/Male","Female", "Male"))
i_g_groupfm
```

##### Urban/Rural
```{r incomeind_ur}
i_glab_ur<- c("Urban: Wage earnings", "Urban: Self-employment earnings", 
                 "Urban: Agricultural earnings", 
                 "Rural: Wage earnings", "Rural:  Self-employment earnings", 
                 "Rural: Agricultural earnings", "Urban Total Earnings", "Rural Total Earnings")
i_g_groupur <-ii_g_group(covid_batch_ur, i_glab_ur, factor = covid_batch_ur$urban,title_text = c("Urban/Rural", 'Urban', 'Rural'))
i_g_groupur
# i_g_groupur[[1]]
# i_g_groupur[[2]]
# i_g_groupur[[3]]
```

####
  This plot shows the individual earning in the past 14 days. It also plots three earning sources respectively. If the individual does not perceive income from one or more of the sources, those data points are assigned zeros to assure representativeness for the whole population.  
   
***   

  <font size="5">**Transfers per capita (USD, PPP) - past 14 days**</font>  

  We ask whether in the past 14 days anyone in the household received a gift/assistance of money or goods, and its value, (i) Support from government, NGOs/community groups and politicians, (ii) Net household transfer activities.
  <!-- ???? (i) also in the past 14 days?? -->

####  {.tabset .tabset-pills}

##### Full sample
```{r transfers, echo=FALSE}
presOptions_tf <- function(dygraph){
  dygraph %>% 
  dyAxis("x", pixelsPerLabel = 50 , drawGrid = FALSE, label = "Weeks", rangePad = 20, valueFormatter = htmlwidgets::JS(getMedianDate)) %>%
  dyAxis("y", drawGrid = FALSE , label = "USD, PPP", valueRange = c(-15,8)) %>% 
    dyCrosshair(direction = "vertical") %>%
  presAnnotation() %>%
  dyHighlight(highlightSeriesOpts = list(strokeWidth = 3)) %>%
  dyLegend(width = 500, labelsSeparateLines = TRUE) 
}

tf_g  <- dygraph(tf, main = "") %>%
  dySeries("i5_wins", strokeWidth = 4, label = "Government/NGOs etc") %>%
  dySeries("i6", strokeWidth = 4, label = "Net household transfers") %>%
  presOptions_tf() %>% 
  dyOptions(colors = RColorBrewer::brewer.pal(3, "Dark2"),axisLineWidth = 4, includeZero = TRUE, connectSeparatedPoints = FALSE,drawPoints = TRUE, pointSize = 4)
tf_g
```

##### Female/Male
```{r tf_fm}
tf_g_group <- function(dataset, factor, group_label, title_text){
  # Variable prep, careful with the order and v_ab[]
  v_ab <- data_group(dataset, colnames(tf), factor) #colnames(tf) = c("twoweeks" "i5_wins"  "i6")
    v_ab.col <- colnames(v_ab)
  #graghing 
  g <- dygraph(v_ab) %>% # group
    dySeries(v_ab.col[2], strokeWidth = 4, label = group_label[1], strokePattern = "dashed") %>%
    dySeries(v_ab.col[3], strokeWidth = 4, label = group_label[2], strokePattern = "dashed") %>%
    dySeries(v_ab.col[4], strokeWidth = 4, label = group_label[3],color = "red2") %>%
    dySeries(v_ab.col[5], strokeWidth = 4, label = group_label[4], color = "dodgeblue3") %>%
    presOptions_tf() %>%
    dyOptions(colors = c( "#1B9E77" ,"#D95F02", "#1B9E77", "#D95F02"),axisLineWidth = 4, includeZero = TRUE, connectSeparatedPoints = FALSE,drawPoints = TRUE, pointSize = 4)
}

tf_glab_fm <- c("Female: Government/NGOs etc)", "Female: Net household transfers","Male: Government/NGOs etc)", "Male: Net household transfers")

##???
tf_glab_ur <- c("Urban: Government/NGOs etc)", "Urban: Net household transfers","Rural: Government/NGOs etc)", "Rural: Net household transfers")

tf_glab_tc <- c("Treatment: Government/NGOs etc)", "Treatment: Net household transfers","Control: Government/NGOs etc)", "Control: Net household transfers")

tf_glab_oy <- c("Older: Government/NGOs etc)", "Older: Net household transfers","Younger: Government/NGOs etc)", "Younger: Net household transfers")


tf_g_groupfm <- tf_g_group(covid_batch_mf, covid_batch_mf$female, tf_glab_fm, title_text = "by gender")

tf_g_groupur <- tf_g_group(covid_batch_ur, factor = covid_batch_ur$urban, tf_glab_ur, "by Urban/Rural")

tf_g_grouptc <- tf_g_group(covid_batch_tc, factor = covid_batch_tc$psdp_treat, tf_glab_tc, "by PSDP Treatment")

tf_g_groupoy <- tf_g_group(covid_batch_oy, factor = covid_batch_oy$older, tf_glab_oy, "by PSDP Age")

tf_g_groupfm
```

##### Urban/Rural  
```{r tf_ur}
tf_g_groupur
```


####

*** 


### Consumption

<font size="5">**Weekly consumption per capita (USD, PPP)**</font>


####  {.tabset .tabset-pills}

##### Full sample
``` {r consumption, fig_width = 10, fig_height = 5}
# func with stacked
presOptions_cons<- function(dygraph) {
  dygraph %>%
  dyAxis("x", label = "Weeks", drawGrid = FALSE, valueRange = c(0,20), rangePad = 20, valueFormatter = htmlwidgets::JS(getMedianDate)) %>% #grid , pixelsPerLabel = 50
  dyAxis("y", label = "USD, PPP (2018)", drawGrid = FALSE, valueRange = c(0,65)) %>% #valueRange
  dyLegend(width = 250, labelsSeparateLines = TRUE) %>%
  dyCrosshair(direction = "vertical") %>%
  presAnnotation() %>%
  dyHighlight(highlightSeriesOpts = list(strokeWidth = 3)) %>% 
   dyLimit(limit = covid_batch$c4_precovid[3], "Pre-COVID average, Total consumption", strokePattern = "dotted", color = "green")
}
# full sample graph
c_g <- dygraph(c, main = "", group = "consumption") %>% 
    dySeries("c4_wins", strokeWidth = 6, pointSize = 6, label = "Total consumption") %>% 
    dySeries("c2_wins", strokeWidth = 4, label = "Food consumption") %>%
  dySeries("c3_wins", strokeWidth = 4, label = "Non-food expenditure") %>%
  dyOptions(stackedGraph = FALSE, includeZero = TRUE, connectSeparatedPoints = FALSE, axisLineWidth = 4, drawPoints = TRUE, pointSize = 4, colors = RColorBrewer::brewer.pal(3, "Set2")) %>%
#  dySeries("c1_wins", strokeWidth = 4, label = "Food expenditure") %>%
  presOptions_cons() 
c_g

```


##### Female/Male {class="row"}

```{r consumption_fm}
# func
c_g_group <- function(dataset, factor, group_label){
  consumption_var <- c("twoweeks", "c3_wins", "c2_wins", "c4_wins")
  v_ab <- data_group(dataset, consumption_var, factor)
    v_ab.col <- colnames(v_ab)


c_g_ab <- dygraph(v_ab, main = "")%>% 
    dySeries(v_ab.col[4], strokeWidth = 6, pointSize = 6, label = group_label[7], strokePattern = "dashed") %>%
    dySeries(v_ab.col[7], strokeWidth = 6, pointSize = 6, label = group_label[8], strokeBorderWidth = 1) %>%
    dySeries(v_ab.col[3], strokeWidth = 4, label = group_label[2], strokePattern = "dashed") %>%
    dySeries(v_ab.col[6], strokeWidth = 4, label = group_label[5]) %>%
      dySeries(v_ab.col[2], strokeWidth = 4, label = group_label[1], strokePattern = "dashed") %>%
      dySeries(v_ab.col[5], strokeWidth = 4, label = group_label[4]) %>%
    presOptions_cons() %>% 
    dyOptions(stackedGraph = FALSE, colors = c("#66C2A5", "#66C2A5", "#FC8D62", "#FC8D62", "#8DA0CB","#8DA0CB"), fillGraph = FALSE, strokeBorderWidth = 1, includeZero = TRUE, connectSeparatedPoints = FALSE, axisLineWidth = 4, drawPoints = TRUE, pointSize = 4)
}

c_glab_fm <- c("Female: Non-food expenditure", "Female: Food consumption", 
                 "Female: Food expenditure", 
                 "Male: Non-food expenditure", "Male: Food consumption", 
                 "Male: Food expenditure","Female: Total consumption","Male: Total consumption")
c_g_groupfm <- c_g_group(covid_batch_mf, factor = covid_batch_mf$female, c_glab_fm)
c_g_groupfm

```
 
##### Urban/Rural {class="row"}

```{r consumption_ur}
c_glab_ur <- c("Urban: Non-food expenditure", "Urban: Food consumption", 
                 "Urban: Food expenditure", 
                 "Rural: Non-food expenditure", "Rural: Food consumption", 
                 "Rural: Food expenditure","Urban: Total consumption","Rural: Total consumption")

c_g_groupur <- c_g_group(covid_batch_ur, c_glab_ur, factor = covid_batch_ur$urban)
c_g_groupur

```
 

<!-- ##### PSDP Treatment/Control {class="row"} -->

<!-- ```{r consumption_tc} -->
<!-- c_glab_tc <- c("Treatment: Non-food expenditure", "Treatment: Food consumption",  -->
<!--                  "Treatment: Food expenditure",  -->
<!--                  "Control: Non-food expenditure", "Control: Food consumption",  -->
<!--                  "Control: Food expenditure","Treatment: Total consumption","Control: Total consumption") -->

<!-- c_g_grouptc <- c_g_group(covid_batch_tc, c_glab_tc, factor = covid_batch_tc$psdp_treat) -->
<!-- c_g_grouptc -->

<!-- ``` -->

<!-- ##### PSDP Older/Younger {class="row"} -->


<!-- ```{r consumption_oy} -->
<!-- i_glab_oy<- c("Older: Non-food expenditure", "Older: Food consumption",  -->
<!--                  "Older: Food expenditure",  -->
<!--                  "Younger: Non-food expenditure", "Younger: Food consumption",  -->
<!--                  "Younger: Food expenditure","Older: Total consumption","Younger: Total consumption") -->
<!-- c_g_groupoy <-c_g_group(covid_batch_oy, i_glab_oy, factor = covid_batch_oy$older) -->
<!-- c_g_groupoy -->
<!-- ``` -->

#### 

This plot presents the average per-capita consumption expenditure in the last 7 days, across all working-age household members. It shows the total per capita consumption, also food consumption and non-food expenditure respectively.

***


*** 

### Food Security  

<font size="5">**Worry about food in the past 7 days**</font>


####  {.tabset .tabset-pills}

##### Full sample
```{r worry}
f1_w <- covid_batch %>% 
  select(twoweeks, f1_worry)

f1_w_g  <- dygraph(f1_w, main = "") %>%
  dySeries("f1_worry", strokeWidth = 4, label = "Worry about not enough food") %>%
  dyAxis("x", pixelsPerLabel = 50 , drawGrid = FALSE, label = "Weeks", rangePad = 20, valueFormatter = htmlwidgets::JS(getMedianDate)) %>% #grid
  dyAxis("y", drawGrid = FALSE , label = "Number of days", valueRange = c(0,1.1)) %>% 
  dyOptions(axisLineWidth = 4, includeZero = TRUE, connectSeparatedPoints = FALSE,drawPoints = TRUE, pointSize = 4, colors = RColorBrewer::brewer.pal(6, "Set1")) %>%
    dyCrosshair(direction = "vertical") %>%
  presAnnotation() %>%
  dyHighlight(highlightSeriesOpts = list(strokeWidth = 3)) %>%
  dyLegend(width = 220, labelsSeparateLines = TRUE) 
f1_w_g
```

##### Female/Male 
```{r worry_fm}
f1_w_group <- function(dataset, factor, text){
    f1w_var <- c("twoweeks", "f1_worry")
    v_ab <- data_group(dataset, f1w_var, factor)
    v_ab.col <- colnames(v_ab)
 f1_w <- dygraph(v_ab, main = "", group = "cc") %>%
  dySeries(v_ab.col[2], strokeWidth = 4, label = paste0(text[1],": Worry about not enough food"),strokePattern = "dashed") %>%
  dySeries(v_ab.col[3], strokeWidth = 4, label = paste0(text[2],":  Worry about not enough food")) %>%
  dyAxis("x", pixelsPerLabel = 50 , drawGrid = FALSE, label = "Weeks", rangePad = 20, valueFormatter = htmlwidgets::JS(getMedianDate)) %>% #grid
  dyAxis("y", drawGrid = FALSE , label = "Number of days", valueRange = c(0,1.1)) %>% 
  dyOptions(axisLineWidth = 4, includeZero = TRUE, connectSeparatedPoints = FALSE, drawPoints = TRUE, pointSize = 4, colors = c("#E31A1C","#FB9A99")) %>%
  dyCrosshair(direction = "vertical") %>%
  presAnnotation() %>%
  dyHighlight(highlightSeriesOpts = list(strokeWidth = 3)) %>%
  dyLegend(width = 220, labelsSeparateLines = TRUE) 
 f1_w
}
  
f1_w_fm <- f1_w_group(covid_batch_mf, covid_batch_mf$female, c("Female","Male"))
f1_w_ur <- f1_w_group(covid_batch_ur, covid_batch_ur$urban, c("Urban","Rural"))
f1_w_tc <- f1_w_group(covid_batch_tc, covid_batch_tc$psdp_treat, c("Treatment","Control"))
f1_w_oy <- f1_w_group(covid_batch_oy, covid_batch_oy$older, c("Older","Younger"))

f1_w_fm
```


##### Urban/Rural
```{r worry_ur}
f1_w_ur
```


####
We asked whether the respondents worry that their household would not have enough food in the last 7 days.

***


<font size="5">**Number of days with food struggles in the past 7 days**</font>

```{r struggles}
f1_d_g  <- dygraph(f1_d, main = "") %>%
    dySeries("f1_d_hungryadult", strokeWidth = 4, label = "Adults gone to bed hungry") %>%
  dySeries("f1_d_hungrychild", strokeWidth = 4, label = "Children gone to bed hungry") %>%
  dySeries("f1_d_skippedadult", strokeWidth = 4, label = "Adults skipped meals") %>%
  dySeries("f1_d_skippedchild", strokeWidth = 4, label = "Children skipped meals") %>%
  dySeries("f1_d_nofoodadult", strokeWidth = 4, label = "Adults gone no food") %>%
  dySeries("f1_d_nofoodchild", strokeWidth = 4, label = "Children gone no food") %>%
  dyAxis("x", pixelsPerLabel = 50 , drawGrid = FALSE, label = "Weeks", rangePad = 20, valueFormatter = htmlwidgets::JS(getMedianDate)) %>% #grid
  dyAxis("y", drawGrid = FALSE , label = "Number of days", valueRange = c(0,3.5)) %>% 
  dyOptions(axisLineWidth = 4, includeZero = TRUE, connectSeparatedPoints = FALSE,drawPoints = TRUE, pointSize = 4, colors = RColorBrewer::brewer.pal(6, "Paired")) %>%
    dyCrosshair(direction = "vertical") %>%
  presAnnotation() %>%
  dyHighlight(highlightSeriesOpts = list(strokeWidth = 3)) %>%
  dyLegend(width = 220, labelsSeparateLines = TRUE) 
f1_d_g
```

####

***  
 
<font size="5">**Food Security Index**</font>

Food Security Index is the weighted index of answers to questions 5.24b-26b.b, negatively coded so that greater values indicate greater food security.

```{r food_index}
f1_idx_g  <- dygraph(f1_idx, main = "") %>%
 dySeries("f1", strokeWidth = 4, label = "Food Security Index") %>%
  dySeries("f3", strokeWidth = 4, label = "Children Food Security Index") %>%
  dySeries("f4", strokeWidth = 4, label = "Adults Food Security Index") %>%
  dyAxis("x", pixelsPerLabel = 50 , drawGrid = FALSE, label = "Weeks", rangePad = 20, valueFormatter = htmlwidgets::JS(getMedianDate)) %>% #grid
  dyAxis("y", drawGrid = FALSE , label = "Index", valueRange = c(-0.5,0.5)) %>% 
  dyOptions(axisLineWidth = 4, includeZero = TRUE, connectSeparatedPoints = FALSE,drawPoints = TRUE, pointSize = 4, colors = RColorBrewer::brewer.pal(4, "Set1")) %>%
    dyCrosshair(direction = "vertical") %>%
  presAnnotation() %>%
  dyHighlight(highlightSeriesOpts = list(strokeWidth = 3)) %>%
  dyLegend(width = 220, labelsSeparateLines = TRUE) 
f1_idx_g
```

***

 <font size="5">**Proportion of Households having meals include:**</font>  

####  {.tabset .tabset-pills}

##### Full sample

```{r struggles2, echo=FALSE}
f1_meals_g  <- dygraph(f1_meals, main = "") %>%
  dySeries("f1_meat", strokeWidth = 4, label = "Meat or Fish") %>%
  dySeries("f1_eggs", strokeWidth = 4, label = "Eggs") %>%
  dyAxis("x", pixelsPerLabel = 50 , drawGrid = FALSE, label = "Weeks", rangePad = 20, valueFormatter = htmlwidgets::JS(getMedianDate)) %>% #grid
  dyAxis("y", drawGrid = FALSE , label = "Proportion of HHs", valueRange = c(0:1)) %>% 
  dyOptions(axisLineWidth = 4, includeZero = TRUE, connectSeparatedPoints = FALSE,drawPoints = TRUE, pointSize = 4, colors = RColorBrewer::brewer.pal(4, "Set1")) %>%
    dyCrosshair(direction = "vertical") %>%
  presAnnotation() %>%
  dyHighlight(highlightSeriesOpts = list(strokeWidth = 3)) %>%
  dyLegend(width = 250, labelsSeparateLines = FALSE)
f1_meals_g
```   

##### Female/Male 
```{r meat_fm}
f1_meals_group <- function(dataset, factor, text){
    f1w_var <- c("twoweeks", "f1_meat", "f1_eggs")
    v_ab <- data_group(dataset, f1w_var, factor)
    v_ab.col <- colnames(v_ab)
 f1_w <- dygraph(v_ab, main = "") %>%
  dySeries(v_ab.col[2], strokeWidth = 4, label = paste0(text[1],": Meat or Fish"), strokePattern = "dashed") %>%
  dySeries(v_ab.col[4], strokeWidth = 4, label = paste0(text[2],": Meat or Fish")) %>%
      dySeries(v_ab.col[3], strokeWidth = 4, label = paste0(text[1],": Eggs"),strokePattern = "dashed") %>%
      dySeries(v_ab.col[5], strokeWidth = 4, label = paste0(text[2],":  Eggs")) %>%
  dyAxis("x", pixelsPerLabel = 50 , drawGrid = FALSE, label = "Weeks", rangePad = 20, valueFormatter = htmlwidgets::JS(getMedianDate)) %>% #grid
  dyAxis("y", drawGrid = FALSE , label = "Proportion of HHs", valueRange = c(0:1.2)) %>% 
  dyOptions(axisLineWidth = 4, includeZero = TRUE, connectSeparatedPoints = FALSE,drawPoints = TRUE, pointSize = 4, colors = c("#E41A1C" ,"#E41A1C","#377EB8", "#377EB8")) %>%
  dyCrosshair(direction = "vertical") %>%
  presAnnotation() %>%
  dyHighlight(highlightSeriesOpts = list(strokeWidth = 3)) %>%
  dyLegend(width = 250, labelsSeparateLines = TRUE)
f1_w
}
  
f1_meals_fm <- f1_meals_group(covid_batch_mf, covid_batch_mf$female, c("Female","Male"))
f1_meals_ur <- f1_meals_group(covid_batch_ur, covid_batch_ur$urban, c("Urban","Rural"))
f1_meals_tc <- f1_meals_group(covid_batch_tc, covid_batch_tc$psdp_treat, c("Treatment","Control"))
f1_meals_oy <- f1_meals_group(covid_batch_oy, covid_batch_oy$older, c("Older","Younger"))

f1_meals_fm
```


##### Urban/Rural
```{r meat_ur}
f1_meals_ur
```


We ask whether any of the meals the household ate yesterday include a)meat or fish, b)eggs.
     
***  
   
   <!-- <font size="5">**Other food hardship experiences, percentage of sample**</font> -->

  
  
```{r struggles3, eval=FALSE, include=FALSE}
f1a_g  <- dygraph(f1a, main = "") %>%
  dySeries("f1_h_reduce_wins", strokeWidth = 4, label = "Had to reduce meals") %>%
  dySeries("f1_h_going_wins", strokeWidth = 4, label = "Mobility restrictions impede going to market") %>%
  dySeries("f1_h_closed_wins", strokeWidth = 4, label = "Closed food markets") %>%
  dyAxis("x", pixelsPerLabel = 90 , drawGrid = FALSE, label = "Weeks", rangePad = 20, valueFormatter = htmlwidgets::JS(getMedianDate)) %>% #grid
  dyAxis("y", drawGrid = FALSE , label = "Proportion of sample") %>% 
  dyOptions(axisLineWidth = 4, includeZero = TRUE, connectSeparatedPoints = FALSE,drawPoints = TRUE, pointSize = 4, colors = RColorBrewer::brewer.pal(4, "Set2")) %>%
    dyCrosshair(direction = "vertical") %>%
  presAnnotation("3", text = "April 25") %>%
  presAnnotation("7", text = "May 23") %>%
  dyHighlight(highlightSeriesOpts = list(strokeWidth = 3)) %>%
  dyLegend(width = 475, labelsSeparateLines = FALSE) %>% 
  dyRangeSelector(dateWindow = c("2", "8"))
f1a_g
``` 
 <!-- We ask whether in the past 7 days, any household member experienced: (i) having to reduce the number of meals and/or the portion of each meal they would usually eat, (ii) difficulties in going to food markets due to mobility restrictions imposed by government, and (iii) difficulties in buying food due to most food markets being closed. -->
  
***  

### COVID-19  

<font size="5">**COVID-19 Prevalence**</font>



####  {.tabset .tabset-pills}

##### Full sample

```{r prevalence, echo=FALSE}
  prevalence <- c("twoweeks","cs4","cs1","cs2", "cs3")
  prevalence <- covid_batch[prevalence]
#  colnames(cbc)[2:4] <- cbc_col

presOptions_prevalence<- function(dygraph) {
  dygraph %>%  
      dyAxis("x", pixelsPerLabel = 50 , drawGrid = FALSE, label = " \n Weeks", ) %>% #grid
    dyAxis("y", drawGrid = FALSE, label = "Proportion of sample", valueRange = c(0,0.21)) %>% #grid
    dyLegend(width = 400, labelsSeparateLines = TRUE) %>%
    dyOptions(axisLineWidth = 4, includeZero = TRUE, connectSeparatedPoints = FALSE, drawPoints = TRUE, pointSize = 4)%>%
    presAnnotation(below = TRUE) %>%
    dyHighlight(highlightSeriesOpts = list(strokeWidth = 3)) %>%
 #   dyEvent(1.7 , "Face masks mandatory", labelLoc = "bottom") %>%
    dyCrosshair(direction = "vertical")
}

prevalence_g <- dygraph(prevalence[c(1,3,4)], main = "") %>%
   dySeries("cs1", strokeWidth = 4, label = "HH member contracted", color = "#d95f02") %>%
   dySeries("cs2", strokeWidth = 4, label = "Know someone (non-HH) contracted", color = "#7570b3") %>%
   presOptions_prevalence()
prevalence_g
```

##### Female/Male
```{r covp_fm}
#func
covp_g_group <- function(dataset, factor, group_label, title_text){
  v_ab <- data_group(dataset, c("twoweeks","cs1","cs2"), factor)
    v_ab.col <- colnames(v_ab)
  #graghing 
  g <- dygraph(v_ab, main = "") %>% # grouping
    dySeries(v_ab.col[2], strokeWidth = 4, label = group_label[1], strokePattern = "dashed", color = "red2") %>%
    dySeries(v_ab.col[4], strokeWidth = 4, label = group_label[3],color = "red2") %>%
    dySeries(v_ab.col[3], strokeWidth = 4, label = group_label[2], strokePattern = "dashed", color = "dodgeblue3") %>%
    dySeries(v_ab.col[5], strokeWidth = 4, label = group_label[4], color = "dodgeblue3") %>%
    presOptions_prevalence() %>%
    dyOptions(colors = c("#d95f02", "#fc8d62", "#7570b3", "#8da0cb"),axisLineWidth = 4, includeZero = TRUE, connectSeparatedPoints = FALSE, drawPoints = TRUE, pointSize = 4)
}

covp_glab_fm <- c("Female: HH member contracted", "Female: Know someone (non-HH) contracted", "Male: HH member contracted", "Male: Know someone (non-HH) contracted")

covp_glab_ur <- c("Urban: HH member contracted", "Urban: Know someone (non-HH) contracted", "Rural: HH member contracted", "Rural: Know someone (non-HH) contracted")

covp_glab_tc <- c("Treatment: HH member contracted", "Treatment: Know someone (non-HH) contracted", "Control: HH member contracted", "Control: Know someone (non-HH) contracted")

covp_glab_oy <- c("Older: HH member contracted", "Older: Know someone (non-HH) contracted", "Younger: HH member contracted", "Younger: Know someone (non-HH) contracted")


covp_g_groupfm <- covp_g_group(covid_batch_mf, covid_batch_mf$female, covp_glab_fm, title_text = "by gender")

covp_g_groupur <- covp_g_group(covid_batch_ur, factor = covid_batch_ur$urban, covp_glab_ur, "Urban/Rural")

covp_g_grouptc <- covp_g_group(covid_batch_tc, factor = covid_batch_tc$psdp_treat, covp_glab_tc, "Treatment/Control")

covp_g_groupoy <- covp_g_group(covid_batch_oy, factor = covid_batch_oy$older, covp_glab_oy, "Older/Younger")

 covp_g_groupfm
```


##### Urban/Rural
```{r covp_ur}
covp_g_groupur
```


####

***

<font size="5">**Reported COVID-19 Knowledge**</font>

####  {.tabset .tabset-pills}

##### Full sample 


```{r knowledge, echo=FALSE}
  ckn_lab <- c("Prevention measures Correct", "Prevention measures Incorrect", "Symptoms Correct", "Symptoms Incorrect")
  #74c476',"#fb6a4a"
ckn_g <- dygraph(ckn, main = "", width = 700) %>%
  dySeries("ckn1", strokeWidth = 4, label = ckn_lab[1],  color = "#41ab5d") %>% 
  dySeries("ckn2", strokeWidth = 4, label = ckn_lab[2], color = "#41ab5d") %>% 
  dySeries("ckn3", strokeWidth = 4, label = ckn_lab[3], color = "#807dba") %>%
  dySeries("ckn4", strokeWidth = 4, label = ckn_lab[4],color = "#807dba") %>% 
    dyAxis("x", pixelsPerLabel = 50 , drawGrid = FALSE, label = "Weeks", rangePad = 20, valueFormatter = htmlwidgets::JS(getMedianDate)) %>% 
    dyAxis("y", drawGrid = FALSE, label = "Sum of answers", valueRange = c(0,8), rangePad = 2) %>% 
    dyLegend(width = 600, labelsSeparateLines = TRUE) %>%
    dyOptions(axisLineWidth = 4, includeZero = TRUE, drawPoints = TRUE, pointSize = 4, colors =   c("#43a2ca","#9ecae1","#ec7014","#fec44f"))%>%
            #  , colors = RColorBrewer::brewer.pal(4, "Set2")) %>%
    presAnnotation(below = TRUE) %>%
    dyHighlight(highlightSeriesOpts = list(strokeWidth = 3)) %>%
 #   dyEvent(1.7 , "Face masks mandatory", labelLoc = "bottom") %>%
    dyCrosshair(direction = "vertical")
  ckn_g

```

##### Female/Male {.few .dygraph-legend}
```{r ckn_fm}
cnk_color <- c()
#func
ckn_g_group <- function(dataset, factor, group_label, title_text){
  v_ab <- data_group(dataset, c("twoweeks","ckn1","ckn2","ckn3","ckn4"), factor)
    v_ab.col <- colnames(v_ab)
  #graghing 
  g <- dygraph(v_ab, main = "") %>% # grouping
    dySeries(v_ab.col[2], strokeWidth = 4, label = group_label[1], strokePattern = "dashed") %>%
    dySeries(v_ab.col[4], strokeWidth = 4, label = group_label[3], strokePattern = "dashed") %>%
    dySeries(v_ab.col[3], strokeWidth = 4, label = group_label[2], strokePattern = "dashed") %>%
    dySeries(v_ab.col[5], strokeWidth = 4, label = group_label[4], strokePattern = "dashed") %>%
        dySeries(v_ab.col[6], strokeWidth = 4, label = group_label[5]) %>%
    dySeries(v_ab.col[7], strokeWidth = 4, label = group_label[6]) %>%
    dySeries(v_ab.col[8], strokeWidth = 4, label = group_label[7]) %>%
    dySeries(v_ab.col[9], strokeWidth = 4, label = group_label[8]) %>%
    dyAxis("x", pixelsPerLabel = 50 , drawGrid = FALSE, label = "Weeks", rangePad = 20, valueFormatter = htmlwidgets::JS(getMedianDate)) %>% 
    dyAxis("y", drawGrid = FALSE, label = "Sum of answers", valueRange = c(0,8)) %>% 
    dyLegend(width = 600, labelsSeparateLines = TRUE) %>%
    presAnnotation(below = TRUE) %>%
    dyHighlight(highlightSeriesOpts = list(strokeWidth = 3)) %>%
 #   dyEvent(1.7 , "Face masks mandatory", labelLoc = "bottom") %>%
    dyCrosshair(direction = "vertical") %>% 
    dyOptions(colors = c("#43a2ca","#9ecae1","#ec7014","#fec44f","#43a2ca","#9ecae1","#ec7014","#fec44f"), axisLineWidth = 4, includeZero = TRUE, drawPoints = TRUE, pointSize = 4)

}


ckn_glab_fm <- c("Female: Prevention measures Correct", "Female: Prevention measures Incorrect","Female: Symptoms Correct ","Female: Symptoms Incorrect", "Male: Prevention measures Correct", "Male: Prevention measures Incorrect","Male: Symptoms Correct ","Male: Symptoms Incorrect")

ckn_glab_ur <- c("Urban: Prevention measures Correct", "Urban: Prevention measures Incorrect","Urban: Symptoms Correct ","Urban: Symptoms Incorrect", "Rural: Prevention measures Correct", "Rural: Prevention measures Incorrect","Rural: Symptoms Correct ","Rural: Symptoms Incorrect")

ckn_glab_tc <- c("Treatment: Prevention measures Correct", "Treatment: Prevention measures Incorrect","Treatment: Symptoms Correct ","Treatment: Symptoms Incorrect", "Control: Prevention measures Correct", "Control: Prevention measures Incorrect","Control: Symptoms Correct ","Control: Symptoms Incorrect")

ckn_glab_oy <- c("Older: Prevention measures Correct", "Older: Prevention measures Incorrect","Older: Symptoms Correct ","Older: Symptoms Incorrect", "Younger: Prevention measures Correct", "Younger: Prevention measures Incorrect","Younger: Symptoms Correct ","Younger: Symptoms Incorrect")

ckn_g_groupfm <- ckn_g_group(covid_batch_mf, covid_batch_mf$female, ckn_glab_fm, title_text = "by gender")

ckn_g_groupur <- ckn_g_group(covid_batch_ur, factor = covid_batch_ur$urban, ckn_glab_ur, "Urban/Rural")

ckn_g_grouptc <- ckn_g_group(covid_batch_tc, factor = covid_batch_tc$psdp_treat, ckn_glab_tc, "Treatment/Control")

ckn_g_groupoy <- ckn_g_group(covid_batch_oy, factor = covid_batch_oy$older, ckn_glab_oy, "Older/Younger")

ckn_g_groupfm
```


##### Urban/Rural {.few .dygraph-legend}
```{r ckn_ur}
ckn_g_groupur
```


####   

We ask respondents about the symptoms of COVID-19 and prevention measures that can be taken to lower the risk of COVID-19.

***

<font size="5">**Reported COVID-19 Behavior Changes**</font>

```{r behavior_changes, echo=FALSE}
  cbc_col <- c("Having changed behavior","“Correct” behavioral changes","“Incorrect” behavioral changes")
  colnames(cbc)[2:4] <- cbc_col
  
cbc_g <- dygraph(cbc, main = "") %>% 
   dySeries(cbc_col[1], strokeWidth = 4, label = "Having changed behavior",axis = 'y', color = "#4292c6") %>%
    # dySeries("cbc2", strokeWidth = 4, label = "“Correct” behavioral changes",axis = 'y2') %>%
    # dySeries("cbc3", strokeWidth = 4, label = " “Incorrect” behavioral changes",axis = 'y2') %>%
  dyMultiColumnGroup(cbc_col[2:3], axis = 'y2', color = c('#74c476',"#fb6a4a"))%>%
    dyAxis("x", pixelsPerLabel = 40 , drawGrid = FALSE, label = "Weeks", rangePad = 20, valueFormatter = htmlwidgets::JS(getMedianDate)) %>% #grid
    dyAxis("y", drawGrid = FALSE, label = "Proportion of sample",rangePad = 2, valueRange = c(0,1.1)) %>% #grid
    dyAxis("y2", drawGrid = FALSE, label = "Sum of answers", valueRange = c(0,7), independentTicks = TRUE,rangePad = 2) %>% #grid
    dyLegend(width = 400) %>%
    dyOptions(axisLineWidth = 4, includeZero = TRUE, drawPoints = TRUE, pointSize = 4)%>%
    presAnnotation(below = TRUE) %>%
    dyHighlight(highlightSeriesOpts = list(strokeWidth = 3)) %>%
 #   dyEvent(1.7 , "Face masks mandatory", labelLoc = "bottom") %>%
    dyCrosshair(direction = "vertical")
  cbc_g
```
   
  We ask respondents whether they have changed their behavior in any way since learning about COVID-19, and if so, how has it changed. “Correct” behavior means the behavior that would reduce risk of contracting COVID-19 and vice versa.
  
  ***


<font size="5">**Reported COVID-19 Symptoms, past 14 days**</font>

``` {r symptoms}
  cov1_g <- dygraph(cov1, main = "") %>% 
  dySeries("cov1_fever", strokeWidth = 4, label = "Fever") %>%
  dySeries("cov1_tired", strokeWidth = 4, label = "Tired") %>%
  dySeries("cov1_cough", strokeWidth = 4, label = "Cough") %>%
  dySeries("cov1_dbreath", strokeWidth = 4, label = "Difficulty breathing") %>%
    dyAxis("x", pixelsPerLabel = 50 , drawGrid = FALSE, label = "Weeks", rangePad = 20, valueFormatter = htmlwidgets::JS(getMedianDate)) %>% #grid
    dyAxis("y", drawGrid = FALSE, label = "Proportion of sample") %>% #grid
  dyLegend(width = 500) %>%
  dyOptions(axisLineWidth = 4, includeZero = TRUE, drawPoints = TRUE, pointSize = 4, colors = RColorBrewer::brewer.pal(4, "Set2")) %>%
    dyCrosshair(direction = "vertical") %>%
  presAnnotation() %>%
  dyHighlight(highlightSeriesOpts = list(strokeWidth = 3))
  cov1_g
```
  
We ask respondents whether they or any other household members have experienced any illnesses or symptoms of a given list in the past 14 days.  

*** 



<font size="5">**Social interactions (other than HH members)**</font>

####  {.tabset .tabset-pills}

##### Full sample

```{r interactions, echo=FALSE}
net5_g  <- dygraph(s3, main = "") %>%
  dySeries("s3_4travel", strokeWidth = 4, label = "Travel to another town or city - past 14 days") %>%
#  dySeries("net5_last7_wins", strokeWidth = 4, label = "In the past 7 days") %>%
#  dySeries("net5_today_wins", strokeWidth = 4, label = "Today") %>%
  dyAxis("x", pixelsPerLabel = 50 , drawGrid = FALSE, label = "Weeks", rangePad = 20, valueFormatter = htmlwidgets::JS(getMedianDate)) %>% #grid
  dyAxis("y", drawGrid = FALSE, label = "Proportion of respondent", valueRange = c(0,0.3)) %>% 
  dyLegend(width = 500) %>%
     dyCrosshair(direction = "vertical") %>%
  presAnnotation() %>%
 dyHighlight(highlightSeriesOpts = list(strokeWidth = 3)) %>%
  dyOptions(axisLineWidth = 4, includeZero = TRUE, drawPoints = TRUE, pointSize = 4, colors = RColorBrewer::brewer.pal(4, "Set1"))
net5_g
```

##### Female/Male
```{r inter_fm}
inter_g_group <- function(dataset, factor, group_label, title_text){
  # Variable prep, careful with the order and v_ab[]
  v_ab <- data_group(dataset, c("twoweeks", "s3_4travel"), factor)
    v_ab.col <- colnames(v_ab)
  #graghing 
  g <- dygraph(v_ab) %>% #, main = paste0("Transfers per capita, " , title_text)) %>% #, group = title_text) %>% # grouping
    dySeries(v_ab.col[2], strokeWidth = 4, label = group_label[1], strokePattern = "dashed") %>%
    dySeries(v_ab.col[3], strokeWidth = 4, label = group_label[2] ) %>%
      dyAxis("x", pixelsPerLabel = 50 , drawGrid = FALSE, label = "Weeks", rangePad = 20, valueFormatter = htmlwidgets::JS(getMedianDate)) %>% #grid
  dyAxis("y", drawGrid = FALSE, label = "Proportion of respondent", valueRange = c(0,0.5)) %>% 
  dyLegend(width = 500, labelsSeparateLines = TRUE) %>%
     dyCrosshair(direction = "vertical") %>%
  presAnnotation() %>%
 dyHighlight(highlightSeriesOpts = list(strokeWidth = 3)) %>%
  dyOptions(axisLineWidth = 4, includeZero = TRUE, drawPoints = TRUE, pointSize = 4, colors = c("#E41A1C","#E41A1C"), rightGap = 20)
}

inter_glab_fm <- c("Female: Travel to another town or city - past 14 days", "Male:Travel to another town or city - past 14 days")

inter_glab_ur <- c("Urban: Travel to another town or city - past 14 days", "Rural: Travel to another town or city - past 14 days")

inter_glab_tc <- c("Treatment: Travel to another town or city - past 14 days", "Control: Travel to another town or city - past 14 days")

inter_glab_oy <- c("Older: Travel to another town or city - past 14 days", "Younger: Travel to another town or city - past 14 days")

inter_g_groupfm <- inter_g_group(covid_batch_mf, covid_batch_mf$female, inter_glab_fm)

inter_g_groupur <- inter_g_group(covid_batch_ur, factor = covid_batch_ur$urban, inter_glab_ur)

inter_g_grouptc <- inter_g_group(covid_batch_tc, factor = covid_batch_tc$psdp_treat, inter_glab_tc)

inter_g_groupoy <- inter_g_group(covid_batch_oy, factor = covid_batch_oy$older, inter_glab_oy)

inter_g_groupfm
```

##### Urban/Rural  
```{r inter_ur}
inter_g_groupur
```

####
*Need update on other variables*
***  

### Labor Supply

<font size="5">**Total hours worked - last 7 days**</font>

####  {.tabset .tabset-pills}

##### Full sample

``` {r labor}
presOptions_ls<- function(dygraph) {
  dygraph %>%
   dyAxis("x", pixelsPerLabel = 50 , drawGrid = FALSE, label = "Weeks", rangePad = 20, valueFormatter = htmlwidgets::JS(getMedianDate)) %>% #grid
  dyAxis("y", label = "Average hours per respondent", drawGrid = FALSE, valueRange = c(0, 85)) %>% # 
  dyLegend(width = 550 , labelsSeparateLines = FALSE) %>%
    dyCrosshair(direction = "vertical") %>%
      dyCrosshair(direction = "vertical") %>%
  presAnnotation() %>%
  dyHighlight(highlightSeriesOpts = list(strokeWidth = 3)) 
}


l_g <- dygraph(l, main = "") %>%
    dySeries("l4_tc", strokeWidth = 4, label = "Total labor supply") %>%
  dySeries("l1_tc", strokeWidth = 4, label = "Agricultural labor supply") %>%
  dySeries("l2_tc", strokeWidth = 4, label = "Own enterprise labor supply") %>%
  dySeries("l3_tc", strokeWidth = 4, label = "Wage labor supply") %>%
  dyOptions(colors = RColorBrewer::brewer.pal(4, "Set2"),stackedGraph = FALSE, includeZero = TRUE, axisLineWidth = 4, drawPoints = TRUE, pointSize = 4,  connectSeparatedPoints = TRUE) %>% 
  presOptions_ls()
  l_g
```

```{r labor_group}
l_g_group <- function(dataset,factor, group_label, title_text){
  # Variable prep, careful with the order and v_ab[]
  ls_var <- c("twoweeks", "l1_tc", "l2_tc", "l3_tc", "l4_tc")
  v_ab <- data_group(dataset, ls_var, factor)
    v_ab.col <- colnames(v_ab)
  
  #graghing 
  l_g_ab <- dygraph(v_ab[c(1,5,9)],main = "")%>% #paste0("Earnings per capita (USD, PPP) - past 14 day,  ",title_text[1])
    dySeries(v_ab.col[5], strokeWidth = 4, label = group_label[7], strokePattern = "dashed", strokeBorderWidth = 1) %>%
    dySeries(v_ab.col[9], strokeWidth = 4, label = group_label[8], strokeBorderWidth = 1) %>%
    presOptions_ls() %>%
    dyOptions(stackedGraph = FALSE, colors = c("#005a32","#41ab5d"), fillGraph = FALSE,includeZero = TRUE, axisLineWidth = 4, drawPoints = TRUE, pointSize = 4, connectSeparatedPoints = TRUE)
  
  l_g_a <- dygraph(v_ab[1:4], main = title_text[2]) %>% # grouping
    dySeries(v_ab.col[2], strokeWidth = 4, label = group_label[1], strokePattern = "dashed") %>%
    dySeries(v_ab.col[3], strokeWidth = 4, label = group_label[2], strokePattern = "dashed") %>%
    dySeries(v_ab.col[4], strokeWidth = 4, label = group_label[3], strokePattern = "dashed") %>%
    presOptions_ls() %>%
    dyOptions(stackedGraph = TRUE, colors = RColorBrewer::brewer.pal(3, "Set2"), includeZero = TRUE, axisLineWidth = 4, drawPoints = TRUE, pointSize = 4,  connectSeparatedPoints = TRUE)

  l_g_b <- dygraph(v_ab[c(1,6:8)], main = title_text[3])  %>%
    dySeries(v_ab.col[6], strokeWidth = 4, label = group_label[4]) %>%
    dySeries(v_ab.col[7], strokeWidth = 4, label = group_label[5]) %>%
    dySeries(v_ab.col[8], strokeWidth = 4, label = group_label[6]) %>%
    presOptions_ls() %>%
    dyOptions(stackedGraph = FALSE, colors = RColorBrewer::brewer.pal(3, "Set2"), includeZero = TRUE, axisLineWidth = 4, drawPoints = TRUE, pointSize = 4,  connectSeparatedPoints = TRUE)

  g <- list(l_g_ab, l_g_a, l_g_b)
}

# Labels prep
l_glab_fm<- c("Female: Agricultural labor supply", "Female: Own enterprise labor supply", 
                 "Female: Wage labor supply", 
                 "Male: Agricultural labor supply", "Male:  Own enterprise labor supply", 
                 "Male: Wage labor supply","Female: Total labor supply", "Male Total: labor supply")
l_g_groupfm <- l_g_group(covid_batch_mf, covid_batch_mf$female, l_glab_fm, title_text = c("Female/Male","Female", "Male"))


l_glab_ur<- c("Urban: Agricultural labor supply", "Urban: Own enterprise labor supply", 
                 "Urban: Wage labor supply", 
                 "Rural: Agricultural labor supply", "Rural:  Own enterprise labor supply", 
                 "Rural: Wage labor supply", "Urban: Total labor supply", "Rural: Total labor supply")
l_g_groupur <-l_g_group(covid_batch_ur, l_glab_ur, factor = covid_batch_ur$urban,title_text = c("Urban/Rural", 'Urban', 'Rural'))


l_glab_tc<- c("Treatment: Agricultural labor supply", "Treatment: Own enterprise labor supply", 
                 "Treatment: Wage labor supply", 
                 "Control: Agricultural labor supply", "Control:  Own enterprise labor supply", 
                 "Control: Wage labor supply" ,"Treatment: Total labor supply", "Control: Total labor supply")

l_g_grouptc <-l_g_group(covid_batch_tc, l_glab_tc, factor = covid_batch_tc$psdp_treat, title_text = c("by PSDP Treatment", 'Treatment', 'Control'))

l_glab_oy<- c("Older: Agricultural labor supply", "Older: Own enterprise labor supply", 
                 "Older: Wage labor supply", 
                 "Younger: Agricultural labor supply", "Younger:  Own enterprise labor supply", 
                 "Younger: Wage labor supply" ,"Older: Total labor supply", "Younger: Total labor supply")

l_g_groupoy <-l_g_group(covid_batch_oy, l_glab_tc,  factor = covid_batch_oy$older, title_text = c("by PSDP Age", 'Older', 'Younger'))

```

##### Female/Male
```{r labor_fm}
l_g_groupfm[[1]]
l_g_groupfm[[2]]
l_g_groupfm[[3]]
```

##### Urban/Rural
```{r labor_ur}
l_g_groupur[[1]]
l_g_groupur[[2]]
l_g_groupur[[3]]
```

    
####
  This plot shows average weekly labor supply per respondent, and hours worked on each of the three sources respectively. If the respondent does not work any hours on one or more of the labor categories, those data points are assigned zeros to assure representativeness of the whole population. 

  
***
<font size="5">**Child-care hours - past 7 days**</font>  

####  {.tabset .tabset-pills}

##### Full sample
```{r c_care}

presOptions_cc<- function(dygraph) {
  dygraph %>%
   dyAxis("x", pixelsPerLabel = 50 , drawGrid = FALSE, label = "Weeks", rangePad = 20, valueFormatter = htmlwidgets::JS(getMedianDate)) %>% #grid
  dyAxis("y", label = "Average hours per respondent", drawGrid = FALSE, valueRange = c(0, 55)) %>% # 
  dyLegend(width = 550 , labelsSeparateLines = FALSE) %>%
    dyCrosshair(direction = "vertical") %>%
  dyOptions(stackedGraph = FALSE, includeZero = TRUE, axisLineWidth = 4, drawPoints = TRUE, pointSize = 4,  connectSeparatedPoints = TRUE) %>%
      dyCrosshair(direction = "vertical") %>%
  presAnnotation() %>%
  dyHighlight(highlightSeriesOpts = list(strokeWidth = 3)) 
}

ccpink<- "#f768a1"
cclightpink<- "#fa9fb5"

cc_g <- dygraph(cc, main = "") %>%
  dySeries("l5_tc", strokeWidth = 4, label = "Child-care hours", color = ccpink) %>%
 # dyOptions(colors = RColorBrewer::brewer.pal(4, "Dark2")) %>% 
  presOptions_cc()
cc_g
```

##### Female/Male

```{r cc_fm}

cc_g_group <- function(dataset, factor, text){
    cc_var <- c("twoweeks", "l5_tc")
    v_ab <- data_group(dataset, cc_var, factor)
    v_ab.col <- colnames(v_ab)
 cc_g <- dygraph(v_ab, main = "", group = "cc") %>%
  dySeries(v_ab.col[2], strokeWidth = 4, label = paste0(text[1],": Child-care hours"), strokePattern = "dashed", color = ccpink) %>%
  dySeries(v_ab.col[3],strokeWidth = 4, label = paste0(text[2],": Child-care hours"), color = cclightpink) %>%
# dyOptions(colors = RColorBrewer::brewer.pal(4, "Paired") %>% 
  presOptions_cc()
 cc_g
}
  
cc_g_fm <- cc_g_group(covid_batch_mf, covid_batch_mf$female, c("Female","Male"))
cc_g_ur <- cc_g_group(covid_batch_ur, covid_batch_ur$urban, c("Urban","Rural"))
cc_g_tc <- cc_g_group(covid_batch_tc, covid_batch_tc$psdp_treat, c("Treatment","Control"))
cc_g_oy <- cc_g_group(covid_batch_oy, covid_batch_oy$older, c('Older', 'Younger'))

cc_g_fm
```


##### Urban/Rural
```{r cc_ur}
cc_g_ur
```


####

We ask for the number of hours spent doing childcare for the household in the last 7 days (even if it overlapped with other tasks).

***

<font size="5">**Unemployment and Layoffs - past 14 days**</font>  

####  {.tabset .tabset-pills}

##### Full sample
```{r labor_unemply}
presOptions_ue<- function(dygraph) {
  dygraph %>%
  dyAxis("x", pixelsPerLabel = 50 , drawGrid = FALSE, label = "Weeks", rangePad = 20, valueFormatter = htmlwidgets::JS(getMedianDate)) %>% #grid
  dyAxis("y", drawGrid = FALSE , label = "Proportion of households", valueRange = c(0,1.1)) %>% 
  dyOptions(axisLineWidth = 4, includeZero = TRUE,drawPoints = TRUE, pointSize = 4) %>% #colors = RColorBrewer::brewer.pal(4, "Set1")
    dyCrosshair(direction = "vertical") %>%
  presAnnotation() %>%
  dyHighlight(highlightSeriesOpts = list(strokeWidth = 3)) %>%
  dyLegend(width = 450, labelsSeparateLines = TRUE)   
}

d_g  <- dygraph(ue, main = "") %>% #Unemployment and Layoffs
  dySeries("l6", strokeWidth = 4, label = "Unemployment (past 7 days)") %>%
  dySeries("l7", strokeWidth = 4, label = "Layoffs since March 2020") %>%
  dyOptions(colors = RColorBrewer::brewer.pal(4, "Set1"))%>%
  presOptions_ue()
d_g
```

##### Female/Male
```{r unemply_fm}
#func
la_g_group <- function(dataset, factor, group_label, title_text){
  v_ab <- data_group(dataset, c("twoweeks", "l6", "l7"), factor)
    v_ab.col <- colnames(v_ab)
  #graghing 
  g <- dygraph(v_ab, main = "", group = title_text) %>% # grouping
    dySeries(v_ab.col[2], strokeWidth = 4, label = group_label[1], strokePattern = "dashed", color = "red2") %>%
    dySeries(v_ab.col[4], strokeWidth = 4, label = group_label[3],color = "red2") %>%
    dySeries(v_ab.col[3], strokeWidth = 4, label = group_label[2], strokePattern = "dashed", color = "dodgeblue3") %>%
    dySeries(v_ab.col[5], strokeWidth = 4, label = group_label[4], color = "dodgeblue3") %>%
    presOptions_ue() %>%
    dyOptions(colors = c("#E41A1C", "#E41A1C", "#377EB8", "#377EB8"))
}

la_glab_fm <- c("Female: Unemployment (past 7 days)", "Female: Layoffs since March 2020", "Male: Unemployment (past 7 days)", "Male: Layoffs since March 2020")

la_glab_ur <- c("Urban: Unemployment (past 7 days)", "Urban: Layoffs since March 2020", "Rural: Unemployment (past 7 days)", "Rural: Layoffs since March 2020")

la_glab_tc <- c("Treatment: Unemployment (past 7 days)", "Treatment: Layoffs since March 2020", "Control: Unemployment (past 7 days)", "Control: Layoffs since March 2020")

la_glab_oy <- c("Older: Unemployment (past 7 days)", "Older: Layoffs since March 2020", "Younger: Unemployment (past 7 days)", "Younger: Layoffs since March 2020")

ue_g_groupfm <- la_g_group(covid_batch_mf, covid_batch_mf$female, la_glab_fm, title_text = "by gender")

ue_g_groupur <- la_g_group(covid_batch_ur, factor = covid_batch_ur$urban, la_glab_ur, "Urban/Rural")

ue_g_grouptc <- la_g_group(covid_batch_tc, factor = covid_batch_tc$psdp_treat, la_glab_tc, "Treatment/Control")

ue_g_groupoy <- la_g_group(covid_batch_oy, factor = covid_batch_oy$older, la_glab_oy, "Older/Younger")

 ue_g_groupfm
# la_g_groupfm[[1]]
# la_g_groupfm[[2]]
```


##### Urban/Rural
```{r unemply_ur}
ue_g_groupur
```


#### 

In this plot, layoffs describes the proportion of sampled households with members been laid off / lost their job involuntarily since March 2020. Unemployment is calculated as the proportion of sampled households with members actively looking for paid work.

*** 


### Mental Health

<font size="5">**Reported Mental Health**</font>

We asked questions 1-5 on core mental health from the John Hopkins Bloomberg School of Public Health (JHSPH) [resource](https://www.elizabethstuart.org/files/MH_survey-items-request_03_20.pdf).  

See below for more detailed information for each aspect.

```{r mh_all, echo=FALSE}
mh <- c("twoweeks", 'nervous' ,'lonely', 'hopeful', 'phyreaction','depressed')
mh <- covid_batch[mh]

presOptions_mh <- function(dygraph){
  dygraph %>% 
  dyAxis("x", pixelsPerLabel = 50 , drawGrid = FALSE, label = "Weeks", rangePad = 20, valueFormatter = htmlwidgets::JS(getMedianDate)) %>%
  dyOptions(strokeWidth = 4, axisLineWidth = 4, includeZero = TRUE, drawPoints = TRUE, pointSize = 4, strokeBorderWidth = 1) %>%
  dyCrosshair(direction = "vertical") %>%
  presAnnotation() %>%
  dyHighlight(highlightSeriesOpts = list(strokeWidth = 3))  
}


mh_graph_tg <- function(i){
  labs <- c(" ",'nervous' ,'lonely', 'hopeful', 'physical reaction','depressed')
  mhcol <- colnames(mh)
  #graghing 
  g_a <- dygraph(mh, main = "") %>% 
  dySeries(mhcol[i], label = labs[i])    %>% 
  dyAxis("y", drawGrid = FALSE, label = "Proportion of respondent") %>% 
  dyLegend(width = 500) %>%
  dyOptions(colors = RColorBrewer::brewer.pal(6, "Set2"))%>%
  presOptions_mh()  
 g_a
}

# graph all questions together
mh_graph_tg(5)

```

```{r mh_fullsample, echo=FALSE}
mhcolor <- c("#66C2A5","#66C2A5", "#FC8D62", "#8DA0CB", "#E78AC3", "#41ab5d","#B3E2CD", "#FDCDAC", "#9e9ac8", "#fa9fb5", "#74c476")
  
mh_graph <- function(i){
  labs <- c(" ",'nervous' ,'lonely', 'hopeful', 'physical reaction','depressed')
  mhcol <- colnames(mh)
  #graghing 
  g_a <- dygraph(mh[,c(1,i)], main = "", group = "mh") %>% 
  dySeries(mhcol[i], strokeWidth = 4, label = labs[i])    %>% 
  dyAxis("y", drawGrid = FALSE, label = "Proportion of respondent", valueRange = c(0,1.1)) %>% 
  dyLegend(width = 500) %>%
  dyOptions(colors = mhcolor[i])%>%
  presOptions_mh()  
 g_a
}
```

```{r mh_group, echo=FALSE}
mh_g_group <- function(i, mhg, text){
  labs <- c(" ",'nervous' ,'lonely', 'hopeful', 'physical reaction','depressed')
  mhcol <- colnames(mhg)
  #graghing 
  g_a <- dygraph(mhg[,c(1,i,i+5)],main = "") %>% 
  dySeries(mhcol[i], strokeWidth = 4, label = paste0(text[1],": ",labs[i]), strokePattern = "dashed", color = mhcolor[i])  %>% 
  dySeries(mhcol[i+5], strokeWidth = 4, label = paste0(text[2],": ",labs[i]), color = mhcolor[i+5])    %>% 
  dyAxis("y", drawGrid = FALSE, label = "Proportion of respondent", valueRange = c(0,1.1) ) %>% 
  dyLegend(width = 500) %>%
  presOptions_mh()
g_a
  }

mh_g_all <- function(dataset, factor, text){
      mh_var <- c("twoweeks", 'nervous' ,'lonely', 'hopeful', 'phyreaction','depressed')
      mhg1 <- data_group(dataset, mh_var, factor)
      mh_list <- lapply(1:6, function(x){g <- mh_g_group(x,mhg1,text)})
  }
mhg_mf <- mh_g_all(covid_batch_mf, covid_batch_mf$female, c("Female","Male"))
mhg_ur <- mh_g_all(covid_batch_ur, covid_batch_ur$urban, c("Urban","Rural"))
mhg_tc <- mh_g_all(covid_batch_tc, covid_batch_tc$psdp_treat, c("Treatment","Control"))
mhg_oy <- mh_g_all(covid_batch_oy, covid_batch_oy$older, c('Older', 'Younger'))
## mhg_mf[[1]] empty to keep the same index

```


#### 

***


<font size="5">**Depression, CESD-10 (Subsample)**</font>

The **Centre for Epidemiological Studies Depression Scale** (CESD-10) is a 10-item Likert scale questionnaire assessing depressive symptoms in the past week. It includes three items on depressed affect, five items on somatic symptoms, and two on positive affect. Options for each item range from “rarely or none of the time” (score of 0) to “all of the time” (score of 3). Scoring is reversed for positive affect statements. Total scores can range from 0 to 30. **Higher scores suggest greater severity of symptoms.** A subset of respondents receive the CESD survey.
   
The depressed Index is generated from the question: In the past 7 days, have you ever felt hopeful about the future?

####  {.tabset .tabset-pills}

##### Full sample
```{r depressed}
mh_dps <- c("twoweeks", 'depressed','cesd_a','cesd_a_std')
mh_dps <- covid_batch[mh_dps]

mh_cesd_dps <- mh_dps %>% 
  mutate(lwr = cesd_a - 2*cesd_a_std, upr = cesd_a + 2*cesd_a_std) %>% 
  select(-cesd_a_std)

mh_dps <- dygraph(mh_cesd_dps, main = "") %>% #main = "Subsample CESD survey"
  dySeries('depressed', strokeWidth = 4, label = "Depressed")%>% 
  dySeries(c("lwr", "cesd_a", "upr"), strokeWidth = 4, label = "CESD score", axis = "y2") %>%
  dyAxis("y", drawGrid = FALSE, label = "Proportion of respondent", valueRange = c(0,1.1)) %>% #, valueRange = c(0,5.5)) %>% 
  dyAxis("y2", drawGrid = FALSE, label = "Average Score", valueRange = c(0,9.5)) %>% 
  dyLegend(width = 400) %>%
  presOptions_mh() 

mh_dps
# In Groups only CESD
```

##### Female/Male
```{r}
mh_g_dps <- function(dataset, factor, labs){
  mh_dps <- c("twoweeks", 'depressed','cesd_a','cesd_a_std')
  v_ab <- data_group(dataset, mh_dps, factor)
  v_ab <- v_ab %>% 
    mutate(lwr.0 = cesd_a.0 - 2*cesd_a_std.0, upr.0 = cesd_a.0 + 2*cesd_a_std.0) %>% 
    mutate(lwr.1 = cesd_a.1 - 2*cesd_a_std.1, upr.1 = cesd_a.1 + 2*cesd_a_std.1) %>% 
    select(-cesd_a_std.0,-cesd_a_std.1)
  v_ab_col <- colnames(v_ab)

mh_dps <- dygraph(v_ab[c("twoweeks","depressed.1","depressed.0")], main = "") %>% #main = "Subsample CESD survey"
  dySeries('depressed.1', strokeWidth = 4, label = labs[1], strokePattern = "dashed")%>% 
 # dySeries(c("lwr.1", "cesd_a.1", "upr.1"), strokeWidth = 4, label = labs[2], axis = "y2") %>%
    dySeries('depressed.0', strokeWidth = 4, label = labs[3])%>% 
#  dySeries(c("lwr.0", "cesd_a.0", "upr.0"), strokeWidth = 4, label = labs[4], axis = "y2") %>%
  dyAxis("y", drawGrid = FALSE, label = "Proportion of respondent", valueRange = c(0,1.1)) %>% #, valueRange = c(0,5.5)) %>% 
  dyAxis("y2", drawGrid = FALSE, label = "Average Score", valueRange = c(0,9.5)) %>% 
  dyLegend(width = 400) %>%
  presOptions_mh() %>% 
  dyOptions(strokeWidth = 4, axisLineWidth = 4, includeZero = TRUE, drawPoints = TRUE, pointSize = 4, strokeBorderWidth = 1, colors = c("#4a1486","#6a51a3"))

mh_dps
  }

dp_glab_mf <- c("Female: Depressed", "Female: CESD score", "Male: Depressed", "Male: CESD score")

dp_glab_ur <- c("Urban: Depressed", "Urban: CESD score", "Rural: Depressed", "Rural: Layoffs since March 2020")

dp_glab_tc <- c("Treatment: Depressed", "Treatment: CESD score", "Control: Depressed", "Control: CESD score")

dp_glab_oy <- c("Older: Depressed", "Older: CESD score", "Younger: Depressed", "Younger: CESD score")


mh_g_dps_mf <- mh_g_dps(covid_batch_mf, covid_batch_mf$female, dp_glab_mf)
mh_g_dps_ur <- mh_g_dps(covid_batch_ur, covid_batch_ur$urban, dp_glab_ur)
mh_g_dps_tc <- mh_g_dps(covid_batch_tc, covid_batch_tc$psdp_treat, dp_glab_tc)
mh_g_dps_oy <- mh_g_dps(covid_batch_oy, covid_batch_oy$older, dp_glab_oy)

mh_g_dps_mf
```


##### Urban/Rural 
```{r}
mh_g_dps_ur
```

####

***

<font size="5">**Nervous, anxious, or on edge**</font>

In the past 7 days, have you ever felt nervous, anxious, or on edge? 

####  {.tabset .tabset-pills}

##### Full sample
```{r}
mh_graph(2)
```

##### Female/Male
```{r}
mhg_mf[[2]]
```

##### Urban/Rural 
```{r}
mhg_ur[[2]]
```

####

***

<font size="5">**Lonely**</font>

####  {.tabset .tabset-pills}
In the past 7 days, have you ever felt lonely?

##### Full sample
```{r}
mh_graph(3)
```

##### Female/Male
```{r}
mhg_mf[[3]]
```

##### Urban/Rural 
```{r}
mhg_ur[[3]]
```


####

***

<font size="5">**Hopeful**</font>

####  {.tabset .tabset-pills}
In the past 7 days, have you ever felt hopeful about the future?

##### Full sample  
```{r}
mh_graph(4)
```

##### Female/Male  
```{r}
mhg_mf[[4]]
```

##### Urban/Rural   
```{r}
mhg_ur[[4]]
```



####
***

<font size="5">**Physical Reaction**</font>

In the past 7 days, have you ever had physical reactions, such as sweating, trouble breathing, nausea, or a pounding heart, when thinking about your experience (e.g., social distancing, loss of income/work, concerns about infection) with the coronavirus/COVID-19 pandemic?

####  {.tabset .tabset-pills}

##### Full sample  
```{r}
mh_graph(5)
```

##### Female/Male  
```{r}
mhg_mf[[5]]
```

##### Urban/Rural   
```{r}
mhg_ur[[5]]
```


***


## {}


<font size="5">**Daily survey counter by batch**</font>
```{r fig.width=10, fig.height=5, message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(hrbrthemes)
library(plotly)

require(haven)
batch_survey <- read_dta("/Users/zhang/Documents/GitHub/covid/data/surveys_by_date_batch.dta")

#prep
batch_survey$survey_date <- as.Date(batch_survey$survey_date, format="%m-%d-%Y")
batch_survey$batch <- factor(batch_survey$batch, levels=c('1','2','3','4','5'),
  labels=c("Batch 1","Batch 2","Batch 3","Batch 4","Batch 5"))

median_w <-c(3.429, 6.571, 9.571, 13.143, 16.714)
median_d <-as.Date(c(2020-04-27,2020-05-19,2020-06-09,2020-07-04,2020-07-29),format="%m-%d-%Y",origin = as.Date('2020-04-17'))
labs <- c("April 27","May 19","June 09","July 04","July 29")
median_date <- data.frame(batch = c(1:5), date = median_d, labs, t_height = rep(1,5), ymin = rep(0,5))

breaks1st<-seq.Date(as.Date("2020-04-17"), as.Date("2020-08-21"), by=14)
# graphing
p <- ggplot() +
    geom_col(batch_survey, mapping=aes(x = survey_date, y = counter, fill = batch), color="#e9ecef", alpha=0.5, position = position_stack(reverse = TRUE)) +
  scale_fill_manual(values=c("#69b3a2","#404080","#e78ac3","#1f78b4","#fc8d62"), name = "") +
  labs(title ="", x = "Date", y = "Number of Surveys per day", fill = "")+
  scale_x_date(date_labels = "%b %d", breaks=breaks1st)+
  theme(title = element_text(size = 16, hjust = 0.5), axis.title = element_text(size = 16, hjust = 0.5),text = element_text(size = 16),  axis.text.x = element_text(size = 16, angle=60, hjust=1), legend.position = "top") 

ply_p <- ggplotly(p)
ply_p[['x']][['layout']][['font']][['size']] <- 12
ply_p[['x']][['layout']][['xaxis']][['tickfont']][['size']] <- 14
ply_p[['x']][['layout']][['yaxis']][['tickfont']][['size']] <- 14
ply_p
```


<!-- These data comes from phone survey interviews conducted by [REMIT Kenya](http://remitkenya.co.ke/) in Siaya County, Kenya. We are collecting data for a sample of ~12,000 households in the county, which is representative of the whole population. At the same time, our weekly sampling method assures weekly representativeness of the overall sample. -->

<!-- So far we have interviewed 7,812 households, with the following distribution per week: -->


| Batch	| Median Dates	| Week Index |
|------|:-----:|:---------:|
| 1 |	27 April 2020 	| 3.429   |
| 2 |	19 May 2020 	| 6.571 |
| 3 |	09 June 2020  	| 9.571 |
| 4 |	04 July 2020	| 13.143 |
| 5 |	29 July 2020	  |  16.714 |


<!-- | Week	| Dates	| Number of surveys | -->
<!-- |------|:-----:|:---------:| -->
<!-- | Week 2 |	17 April 2020 	| -  | -->
<!-- | Week 4 |	01 May 2020 	| -  | -->
<!-- | Week 6 |	15 May 2020 	| -  | -->
<!-- | Week 8 |	29 May 2020 	| -  | -->
<!-- | Week 10 |	12 June 2020 	  |  -| -->
<!-- | Week 12 |	26 June 2020	    | - | -->
<!-- | Week 14 |	10 July 2020    	| -    | -->
<!-- | Week 16 |	24 July 2020   	| -    | -->
<!-- | Week 18 |	07 August 2020   	| -    | -->
<!-- | Week 20 |	21 August 2020   	| -    | -->


